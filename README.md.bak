# ğŸ” Conditional Access Gap Analyzer

An interactive visualization tool for analyzing Microsoft 365 Conditional Access policies, identifying coverage gaps, and understanding policy relationships across users, groups, roles, and applications.

## ğŸ¯ Overview

This tool helps security teams:
- ğŸ“Š **Visualize** Conditional Access policy relationships and dependencies
- ğŸ” **Identify gaps** in policy coverage (users/groups without policies, policies without assignments)
- ğŸ—ºï¸ **Map assignments** through nested groups and directory roles
- ğŸ“ˆ **Analyze** policy impact across your tenant
- ğŸš€ **Export** data for compliance reporting and documentation

## âœ¨ Features

- **Graph Visualization**: Interactive network graph showing policies, users, groups, roles, and applications
- **Gap Detection**: Automatic identification of coverage gaps and risky configurations
- **Nested Expansion**: Full traversal of group memberships and role assignments
- **Export Formats**: JSON and CSV outputs for further analysis
- **Containerized**: Run natively or in Docker for portability

---

## ğŸš€ Quick Start

### Option A: Native Execution (Recommended for Speed)

**Prerequisites:**
- PowerShell 7+ ([Install](https://learn.microsoft.com/en-us/powershell/scripting/install/installing-powershell))
- Microsoft Graph PowerShell modules

**1. Install PowerShell Modules**
```powershell
Install-Module Microsoft.Graph -Scope CurrentUser -Force
Install-Module Microsoft.Graph.Identity.SignIns -Scope CurrentUser -Force
Install-Module Microsoft.Graph.Identity.DirectoryManagement -Scope CurrentUser -Force
Install-Module Microsoft.Graph.Authentication -Scope CurrentUser -Force
```

**2. Authenticate to Microsoft Graph**
```powershell
Connect-MgGraph -Scopes @(
    'Policy.Read.All',
    'Directory.Read.All',
    'Group.Read.All',
    'Application.Read.All',
    'RoleManagement.Read.Directory'
) -TenantId "your-tenant-id"
```

**3. Run the Complete Pipeline**
```powershell
# If already connected (recommended - much faster!)
./scripts/run-all.ps1 -SkipConnect

# Or connect with device code flow automatically
./scripts/run-all.ps1
```

**4. View Results in Web UI**
```bash
cd web
npm install
npm run dev
```

Open http://localhost:5173 in your browser.

---

### Option B: Docker Execution

**Prerequisites:**
- Docker and Docker Compose

**1. Build the Container**
```bash
docker-compose build
```

**2. Run Collection (Interactive Device Code Flow)**
```bash
docker-compose run --rm collector
```

Follow the device code authentication prompt in your terminal.

**3. Start the Web UI**
```bash
docker-compose up web
```

Open http://localhost:5173 in your browser.

---

## ğŸ”‘ Authentication Guide

### Device Code Flow (Default)
The tool uses device code authentication by default. You'll see:
```
To sign in, use a web browser to open https://microsoft.com/devicelogin
and enter the code XXXXXXXXX to authenticate.
```

### Using an Existing Connection (Faster!)
If you're already connected to Microsoft Graph:
```powershell
# Connect once
Connect-MgGraph -Scopes 'Policy.Read.All', 'Directory.Read.All', ...

# Run multiple times without reconnecting
./scripts/run-all.ps1 -SkipConnect
```

### Required Permissions
- `Policy.Read.All` - Read Conditional Access policies
- `Directory.Read.All` - Read directory objects
- `Group.Read.All` - Read group memberships
- `Application.Read.All` - Read application registrations
- `RoleManagement.Read.Directory` - Read directory role assignments

---

## ğŸ“‚ Output Files

All outputs are generated in the `output/` directory:

| File | Description |
|------|-------------|
| `conditional_access_policies.json` | Complete policy data with expanded assignments |
| `conditional_access_policies.csv` | Flat CSV export for spreadsheet analysis |
| `conditional_access_graph.json` | Graph structure for visualization (nodes + edges) |
| `entities/users.json` | All users in the tenant |
| `entities/groups.json` | All groups with metadata |
| `entities/roles.json` | Directory roles |
| `entities/service_principals.json` | Service principals / applications |
| `entities/named_locations.json` | Named locations (IP ranges, countries) |

Files are automatically copied to `web/public/` for the visualization UI.

---

## ğŸ¨ Web UI Features

### Views
- **Graph View**: Network visualization of policy relationships
- **Gap Highlights**: Policies without assignments, users without policies
- **Detail Panel**: Deep-dive into specific policies, users, or groups

### Filters
- Filter by policy state (enabled/disabled/report-only)
- Filter by entity type (users, groups, roles, applications)
- Search by name or ID

### Export
- Download filtered views as JSON
- Export current graph state

---

## ğŸ—ï¸ Architecture

```
conditional-access-gap/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ run-all.ps1                      # ğŸ”„ Main pipeline orchestrator
â”‚   â”œâ”€â”€ collect-conditional-access.ps1   # ğŸ“¥ Collect policies + expand assignments
â”‚   â”œâ”€â”€ collect-directory-objects.ps1    # ğŸ‘¥ Collect users, groups, roles
â”‚   â””â”€â”€ build-graph-json.ps1             # ğŸ—ºï¸ Build graph structure
â”œâ”€â”€ web/                                 # ğŸ¨ React + TypeScript visualization
â”‚   â”œâ”€â”€ src/
â”‚   â””â”€â”€ public/                          # Data files for visualization
â”œâ”€â”€ output/                              # ğŸ“Š Generated data files
â”œâ”€â”€ Dockerfile                           # ğŸ³ Container definition
â””â”€â”€ docker-compose.yml                   # ğŸ³ Multi-service orchestration
```

### Pipeline Flow
1. **Collect CAPs**: Retrieve all Conditional Access policies
2. **Expand Assignments**: Resolve all users/groups/roles referenced by policies
3. **Collect Objects**: Gather full directory data (users, groups, roles, apps)
4. **Build Graph**: Transform data into visualization-ready format
5. **Copy to Web**: Place outputs in `web/public/` for UI consumption

---

## ğŸ“‹ Comprehensive CAP Coverage

This tool captures **ALL** Conditional Access Policy configurations comprehensively:

### Assignments

| Feature | Captured | Displayed | CSV Export | Graph Nodes |
|---------|----------|-----------|------------|-------------|
| Direct Users | âœ… | âœ… | âœ… | âœ… |
| Groups (with nested expansion) | âœ… | âœ… | âœ… | âœ… |
| Directory Roles (with members) | âœ… | âœ… | âœ… | âœ… |
| Guest/External Users | âœ… | âœ… | âœ… | âœ… |
| External Tenants | âœ… | âœ… | âœ… | âœ… |
| Service Principals | âœ… | âœ… | âœ… | âœ… |

### Target Resources

| Feature | Captured | Displayed | CSV Export | Graph Nodes |
|---------|----------|-----------|------------|-------------|
| All Resources (All cloud apps) | âœ… | âœ… | âœ… | âœ… |
| Individual Applications | âœ… | âœ… | âœ… | âœ… |
| Office 365 Suite | âœ… | âœ… | âœ… | âœ… |
| User Actions | âœ… | âœ… | âœ… | âœ… |
| **Authentication Contexts** | âœ… | âœ… | âœ… | âœ… |
| Global Secure Access Profiles | âœ… | âœ… | âœ… | âœ… |

### Conditions

| Feature | Captured | Displayed | CSV Export | Graph Nodes |
|---------|----------|-----------|------------|-------------|
| User Risk Levels | âœ… | âœ… | âœ… | âœ… |
| Sign-in Risk Levels | âœ… | âœ… | âœ… | âœ… |
| **Insider Risk Levels** | âœ… | âœ… | âœ… | âœ… |
| Service Principal Risk | âœ… | âœ… | âœ… | âœ… |
| Device Platforms | âœ… | âœ… | âœ… | âœ… |
| Locations/Networks (Named) | âœ… | âœ… | âœ… | âœ… |
| Location Types (IP/Country) | âœ… | âœ… | âœ… | âœ… |
| Trusted Location Status | âœ… | âœ… | âœ… | âœ… |
| Client App Types | âœ… | âœ… | âœ… | âœ… |
| **Device Filter (OData rules)** | âœ… | âœ… | âœ… | âœ… |
| **Authentication Flows** | âœ… | âœ… | âœ… | âœ… |
| Device States | âœ… | âœ… | âœ… | âœ… |

### Access Controls - Grant

| Feature | Captured | Displayed | CSV Export |
|---------|----------|-----------|------------|
| Block Access | âœ… | âœ… | âœ… |
| Grant Access | âœ… | âœ… | âœ… |
| Require MFA | âœ… | âœ… | âœ… |
| Require Compliant Device | âœ… | âœ… | âœ… |
| Require Hybrid Azure AD Join | âœ… | âœ… | âœ… |
| Require Approved Client App | âœ… | âœ… | âœ… |
| Require App Protection Policy | âœ… | âœ… | âœ… |
| Require Password Change | âœ… | âœ… | âœ… |
| Authentication Strength | âœ… | âœ… | âœ… |
| Terms of Use | âœ… | âœ… | âœ… |
| Custom Controls | âœ… | âœ… | âœ… |

### Access Controls - Session

| Feature | Captured | Displayed | CSV Export |
|---------|----------|-----------|------------|
| App Enforced Restrictions | âœ… | âœ… | âœ… |
| Conditional Access App Control | âœ… | âœ… | âœ… |
| Sign-in Frequency | âœ… | âœ… | âœ… |
| Persistent Browser Session | âœ… | âœ… | âœ… |
| **Continuous Access Evaluation** | âœ… | âœ… | âœ… |
| **Token Protection** | âœ… | âœ… | âœ… |
| **Secure Sign-in Session** | âœ… | âœ… | âœ… |
| **Global Secure Access Profile** | âœ… | âœ… | âœ… |
| Disable Resilience Defaults | âœ… | âœ… | âœ… |

### Advanced Features

- âœ… **Nested Group Expansion** - Full traversal with "via" paths
- âœ… **Role Member Resolution** - Shows all users assigned to roles
- âœ… **Keyword Detection** - "All", "None", "Office 365", "AllTrusted"
- âœ… **Relationship Tracking** - Complete policy â†’ entity mappings
- âœ… **Gap Analysis** - Identifies coverage gaps and risky configurations

### ğŸ†• Recently Added (Comprehensive Enhancement)

The following features were added to ensure **complete CAP coverage**:

**New Conditions Captured:**
- **Insider Risk Levels** (Microsoft Purview) - minor, moderate, elevated
- **Authentication Flows** - deviceCodeFlow, authenticationTransfer
- **Device Filter Details** - full OData filter rules with mode (include/exclude)

**New Session Controls:**
- **Continuous Access Evaluation (CAE)** - mode detection
- **Token Protection** - phishing-resistant token binding
- **Secure Sign-in Session** - elevated session security
- **Global Secure Access Security Profile** - GSA integration

**Enhanced Targeting:**
- **Authentication Context Class References** - stepped-up auth requirements
- Full support for include/exclude on auth contexts

**Enhanced Export:**
- All new fields available in CSV export
- New CSV columns: `InsiderRiskLevels`, `AuthenticationFlows`, `DeviceFilter_*`, `Session_*`, `*AuthenticationContexts`

**Graph Visualization:**
- New node types: `authenticationContext`, `condition` (for insider risk, auth flows, device filters)
- Enhanced policy nodes with conditions summary and session controls summary

---

## ğŸ› ï¸ Advanced Usage

### Run Individual Scripts

**Collect policies only:**
```powershell
./scripts/collect-conditional-access.ps1 -SkipConnect -SkipDisconnect
```

**Collect directory objects only:**
```powershell
./scripts/collect-directory-objects.ps1 -SkipConnect
```

**Build graph from existing data:**
```powershell
./scripts/build-graph-json.ps1
```

### Docker: Collection Only (No Web UI)
```bash
docker-compose run --rm collector pwsh -File /workspace/scripts/run-all.ps1
```

### Custom Output Directory
```powershell
./scripts/run-all.ps1 -OutputDir "/custom/path"
```

---

## ğŸ”’ Security & Privacy

- âœ… **No data is sent externally** - all processing happens locally
- âœ… **Read-only access** - requires only read permissions
- âœ… **Tenant-scoped** - only accesses your authenticated tenant
- âš ï¸ Output files contain sensitive organizational data - **do not commit to version control**

The `.gitignore` file excludes all output files by default.

---

## ğŸ› Troubleshooting

### "No policies returned"
- Ensure you've completed device code authentication
- Verify you have the required permissions (Global Reader role recommended)
- Check that Conditional Access policies exist in your tenant

### "Failed to resolve group/user"
- Increase permissions to include `Directory.Read.All`
- Some nested groups may require additional time to enumerate

### Web UI shows no data
- Ensure `output/` files have been copied to `web/public/`
- Check that `npm run dev` is running without errors
- Verify `conditional_access_graph.json` exists in `web/public/`

### Container authentication timeout
- Device code has 15-minute timeout - complete authentication promptly
- Use native execution with pre-authenticated session for faster iteration

---

## ğŸ“ License

This tool is provided as-is for security analysis and compliance purposes. Modify and distribute freely.

---

## ğŸ¤ Contributing

Issues and pull requests welcome! Areas for enhancement:
- Additional gap detection heuristics
- More visualization layouts
- Export to other formats (PDF, PowerPoint)
- Real-time policy monitoring

---

## ğŸ“š Resources

- [Microsoft Conditional Access Documentation](https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/)
- [Microsoft Graph PowerShell SDK](https://learn.microsoft.com/en-us/powershell/microsoftgraph/)
- [CIS Microsoft 365 Foundations Benchmark](https://www.cisecurity.org/)

---

**Built for security teams who need clarity in complexity.** ğŸ›¡ï¸

## Quick Start

There are several different ways to authenticate and collect data, the easiest is to perform an Az login command and use the '-SkipConnect' flag to pull all conditional access policies and objects.

```
connect-mggraph
```

To run the CAP collector, the graph creation script, and object collection in powershell: 
```
./scripts/run-all.ps1 -SkipConnect'
```





